<?php

namespace App\Filament\Actions;

use App\Engine\OpenBankingEngine;
use App\Engine\DynamicEngine;
use Filament\Forms\Components\Toggle;
use Filament\Tables\Actions\BulkAction;
use Illuminate\Database\Eloquent\Collection;

class RunEngineBulkAction extends BulkAction
{
    public function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub
        $this->icon('');
        $this->form([
            Toggle::make('update_merchant')
                ->label('Update Merchant')
                ->default(false),
            Toggle::make('detect_internal_transaction')
                ->label('Detect Internal Transaction')
                ->default(false)
        ]);
        $this->action(function (Collection $records, array $data) {
            if ($data['update_merchant']) {
                foreach ($records as $record) {
                    if (!is_null($record->open_banking_transaction))
                    {
                        $data = OpenBankingEngine::parse($record->open_banking_transaction);
                        $record->merchant = $data['merchant'];
                    }
                }
            }
            if ($data['detect_internal_transaction']) {
                $records = DynamicEngine::internalTransaction($records);
            }
            foreach ($records as $record) {
                if ($record->isDirty())
                {
                    $record->save();
                }
            }
        });
    }
}
